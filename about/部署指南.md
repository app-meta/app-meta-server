# æœåŠ¡ç«¯éƒ¨ç½²æŒ‡å—
> ç”±äºæ‰“åŒ…é‡‡ç”¨çš„æ˜¯ç˜¦ JARï¼Œæ•…è¿è¡Œæ—¶éœ€è¦å¢åŠ  `-Dloader.path=lib`

**å¦‚ä½•æ‰“åŒ…**
> æ¨èä½¿ç”¨ `mvnd`ï¼ˆé€Ÿåº¦è¾ƒä¹‹ maven æ›´å¿«ï¼‰

```shell
# ä»¥ä¸‹çš„åŒç­‰ç¡¬ä»¶ä¸‹ï¼Œå®Œå…¨é‡æ–°ç¼–è¯‘æ‰“åŒ…çš„è€—æ—¶è®°å½•

# maven
[INFO] Reactor Summary for app-meta-server 1.0:
[INFO]
[INFO] app-meta-server .................................... SUCCESS [  0.006 s]
[INFO] boot ............................................... SUCCESS [ 11.501 s]
[INFO] meta-server ........................................ SUCCESS [ 29.904 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  42.204 s

# mvnd é»˜è®¤é…ç½®
[INFO] Reactor Summary for app-meta-server 1.0:
[INFO]
[INFO] app-meta-server .................................... SUCCESS [  0.009 s]
[INFO] boot ............................................... SUCCESS [  3.351 s]
[INFO] meta-server ........................................ SUCCESS [ 27.505 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  31.601 s (Wall Clock)
```

## æ–¹å¼ä¸€ï¼šç›´æ¥è¿è¡Œ

`java -Dloader.path=lib -jar meta-server-1.0.jar`

## æ–¹å¼äºŒï¼šPM2 è¿è¡Œ
> å€ŸåŠ© pm2 çš„ watch åŠŸèƒ½å®ç°å½“ jar åŒ…æ›´æ–°ï¼ˆé€šå¸¸æ˜¯æœ‰æ–°ç‰ˆæœ¬ï¼‰åè‡ªåŠ¨é‡å¯åº”ç”¨

1. å®‰è£… pm2
2. åœ¨ jar åŒçº§ç›®å½•ä¸‹æ–°å»º `meta-server.config.js`
```javscript
module.exports = {
	apps:[{
		name: "meta",
		script:"java",
		exec_interpreter:"",
		args:"-jar meta-server-1.0.jar --server.port=10086 --spring.profiles.active=prod",
		watch: ["meta-server-1.0.jar"],
		watch_delay: 10*1000,
		restart_delay: 10*1000
	}]
}
```
3. é€šè¿‡ pm2 è¿è¡Œåº”ç”¨ï¼š`pm2 start meta-server.config.js`
4. OK

ä¸Šè¿°æ–¹æ¡ˆæ˜¯é€šè¿‡ç›‘æµ‹`meta-server-1.0.jar`æ–‡ä»¶æœ¬èº«å®ç°é‡å¯ï¼Œå®é™…ä½¿ç”¨å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šé¦–æ¬¡æ›´æ–° jar èƒ½å¤Ÿæ­£å¸¸å“åº”å®¢æˆ·ç«¯ï¼Œä¹‹åéƒ½æç¤ºè¿æ¥ç»ˆç«¯ï¼ˆä½†èƒ½å¤Ÿæ­£å¸¸é‡å¯ï¼‰

ç°åœ¨æ¢ä¸€ä¸ªæ€è·¯ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹æ–‡ä»¶ï¼ˆæ­¤å¤„æ˜¯`version-jar.txt`ï¼Œæ¯æ¬¡ jar æ›´æ–°éƒ½è¿½åŠ å†…å®¹åˆ°è¯¥æ–‡ä»¶ï¼‰

```javscript
module.exports = {
	apps:[{
		name: "meta",
		script:"java",
		exec_interpreter:"",
		args:"-jar meta-server-1.0.jar --server.port=10086 --spring.profiles.active=prod",
		watch: ["version-jar.txt"],
		watch_delay: 10*1000,
		restart_delay: 10*1000
	}]
}
```

æ­¤ç§æ–¹æ³•ä¹Ÿæœ‰ä¸€å®šæ¦‚ç‡å‡ºç°è¿æ¥ç»ˆç«¯ =.=

### ç˜¦ JAR æ–¹å¼
> ç»å®éªŒï¼Œä½¿ç”¨ç˜¦ jar è¿è¡Œï¼Œæ›´æ–°æˆåŠŸç‡æ›´é«˜

ç¯å¢ƒï¼šwindows 10ã€JDK 17ã€ç›‘æµ‹ jar åŒ…ä»¥é‡å¯

æ¬¡æ•°|å®Œæ•´JAR|ç˜¦JAR
-|-|-
1|âœ…|âœ…
2|âœ…|âœ…
3|âœ…|âœ…
4|âœ…|âœ…
5|âœ…|âœ…
6(é‡æ–°æ‰“åŒ…)|âœ…|âœ…(æç¤ºè¿æ¥ä¸­æ–­)
7|âœ…|âœ…
8|âœ…|âœ…
9|âœ…|âœ…
10|âœ…|âœ…


### å¾…è§£å†³é—®é¢˜

ä½¿ç”¨ pm2 è¿è¡Œæ—¶ï¼Œæ— æ³•åœ¨ java è¿›ç¨‹å†…æ‰§è¡Œ`pm2 xxx`çš„å‘½ä»¤ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
node:child_process:175
  p.open(fd);
    ^
Error: EBADF: bad file descriptor, uv_pipe_open
	at Object._forkChild (node:child_process:175:5)
	at setupChildProcessIpcChannel (node:internal/bootstrap/pre_execution:451:30)
	at prepareMainThreadExecution (node:internal/bootstrap/pre_execution:71:3)
	at node:internal/main/run_main_module:9:1 {
  errno: -4083,
  code: 'EBADF',
  syscall: 'uv_pipe_open'
}
```

å°è¯•è§£å†³ï¼š

1. ä¿®æ”¹æ‰§è¡Œç›®å½•
2. ä½¿ç”¨å…¶ä»–å·¥å…·æ‰§è¡Œ `pm2` å‘½ä»¤

å‡æŠ¥åŒæ ·çš„é”™è¯¯ğŸ˜­

```xml
<!--æ–°å¢ä¾èµ–-->
<dependency>
    <groupId>com.zaxxer</groupId>
    <artifactId>nuprocess</artifactId>
    <version>2.0.6</version>
    <scope>compile</scope>
</dependency>

<dependency>
    <groupId>org.zeroturnaround</groupId>
    <artifactId>zt-exec</artifactId>
    <version>1.12</version>
</dependency>
```

```kotlin
@Component
class CmdWorker  {
    val logger = LoggerFactory.getLogger(javaClass)
    val dir = File("")
    val cmds = listOf("pm2.cmd", "jlist")

    @EventListener(ApplicationStartedEvent::class)
    fun test() {
        mapOf(
            "ProcessBuilderï¼ˆdefaultï¼‰" to { OSTool.runCmd(cmds) },
            "ProcessBuilderï¼ˆspecialï¼‰" to { OSTool.runCmd(listOf("pm2.cmd", "list"), File("D:/")) },
            "NuProcessBuilder"         to {
                val handler = object : NuAbstractProcessHandler() {
                    lateinit var nuProcess: NuProcess
                    var result = ""
                    
                    private fun toText(buffer: ByteBuffer) = ByteArray(buffer.remaining()).let { 
                        buffer.get(it)
                        String(it)
                    }

                    override fun onStart(nuProcess: NuProcess) {
                        this.nuProcess = nuProcess
                    }

                    override fun onStdout(buffer: ByteBuffer, closed: Boolean) {
                        if (!closed) {
                            result = toText(buffer)
                            nuProcess.closeStdin(true)
                        }
                        else
                            logger.info("NuProcessBuilder: closed...")
                    }

                    override fun onStderr(buffer: ByteBuffer, closed: Boolean) {
                        logger.info("NuProcessBuilder: ERROR.....")
                        result = toText(buffer)
                        logger.info("RESULT=${result}")
                    }
                }
                NuProcessBuilder(cmds).also {
                    it.setProcessListener(handler)
                    val p = it.start()
                    p.waitFor(0, TimeUnit.SECONDS)
                }

                handler.result
            },
            "ZT-EXEC"       to {
                ProcessExecutor().command(cmds)
                    .readOutput(true).execute()
                    .outputUTF8()
            }
        ).map { w->
            try {
                logger.info("START RUN ${w.key} ...")
                println(w.value())
                println()
            }catch (e:Exception){
                logger.error("ERROR ON ${w.key}ï¼š${e.message}")
            }
        }
    }
}
```